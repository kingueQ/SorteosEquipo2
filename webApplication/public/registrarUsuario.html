<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Usuario</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <!-- Navbar -->
    <nav>
        <div class="logo">
            <img src="logo.png" alt="Logo de la Plataforma">
            <h1>Plataforma de Sorteos</h1>
        </div>
        <div class="nav-links">
            <a href="registrarUsuario.html">Registrarme</a>
            <a href="iniciarSesion.html">Iniciar Sesión</a>
        </div>
    </nav>
    
    <h2>Registrar Usuario</h2>
    <div class="form-container">
        <form id="registrarUsuarioForm">
          <label for="nombre">Nombre</label>
          <input type="text" id="nombre" name="nombre" required>
      
          <label for="correo">Correo Electrónico</label>
          <input type="email" id="correo" name="correo" required>
      
          <label for="telefono">Teléfono</label>
          <input type="tel" id="telefono" name="telefono" required>
      
          <label for="contrasena">Contraseña</label>
          <input type="password" id="contrasena" name="contrasena" required>
      
          <label for="tipo">Tipo de Usuario</label>
          <select id="tipo" name="tipo" required>
            <option value="cliente">Cliente</option>
            <option value="organizador">Organizador</option>
          </select>
      
          <button type="submit">Registrar</button>
        </form>
      </div>
      

    <div id="messageContainer"></div>

    <script>
        document.getElementById('registrarUsuarioForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                nombre: document.getElementById('nombre').value.trim(),
                correo: document.getElementById('correo').value.trim(),
                telefono: document.getElementById('telefono').value.trim(),
                contrasena: document.getElementById('contrasena').value.trim(),
                tipo: document.getElementById('tipo').value
            };

            try {
                const response = await fetch('http://localhost:3000/api/v1/usuarios/crear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    displayMessage(['Usuario registrado con éxito. Redirigiendo al login...'], 'success');
                    setTimeout(() => {
                        window.location.href = 'iniciarSesion.html';
                    }, 3000);
                } else {
                    try {
                        const error = await response.json();
                        console.log('Error response object:', error);

                        let errorMessages = [];

                        if (typeof error === 'object') {
                            if (typeof error.message === 'object') {
                                // Procesa los mensajes de error por campo
                                errorMessages = Object.entries(error.message).map(
                                    ([field, message]) => `${field}: ${message}`
                                );
                            } else if (typeof error.message === 'string') {
                                errorMessages.push(error.message);
                            } else {
                                // Procesa cualquier otro formato de error
                                errorMessages = Object.entries(error).map(
                                    ([field, message]) => `${field}: ${message}`
                                );
                            }
                        } else {
                            errorMessages.push(error.message || error.error || 'Error desconocido');
                        }

                        displayMessage(['Error al registrar el usuario:', ...errorMessages], 'error');
                    } catch (jsonError) {
                        displayMessage(['Error al registrar el usuario:', 'Error desconocido (fallo al analizar la respuesta)'], 'error');
                    }
                }
            } catch (err) {
                console.error('Error en la solicitud:', err);
                displayMessage(['Error de conexión. Intenta nuevamente.'], 'error');
            }
        });

        function displayMessage(messages, type) {
            const messageContainer = document.getElementById('messageContainer');
            const formattedMessages = messages.map(msg => `<li>${msg}</li>`).join('');
            messageContainer.innerHTML = `
                <div class="alert ${type}">
                    <ul>${formattedMessages}</ul>
                </div>
            `;
        }
    </script>

</body>

</html>
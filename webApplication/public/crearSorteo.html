<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Sorteo</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="css/styles.css">
    <script>
        // Verificar si el usuario ha iniciado sesión
        window.onload = function () {
            const idOrganizador = localStorage.getItem('idOrganizador');
            const tipo = localStorage.getItem('tipoUsuario');
            if (!idOrganizador) {
                alert("Necesitas iniciar sesión");
                window.location.href = "iniciarSesion.html"; // Cambiar a "index.html" si lo prefieres
            }
            if (tipo === 'organizador') {

            } else if (tipo === 'cliente') {
                alert("Esta página es solo para organizadores");
                window.location.href = "inicioCliente.html";
            } else {
                alert("Sesión no encontrada");
                window.location.href = "index.html";
            }
        };
    </script>
</head>

<body>
    <nav>
        <div class="logo">
            <img src="logo.png" alt="Logo de la Plataforma">
            <h1>Plataforma de Sorteos</h1>
        </div>
        <div class="nav-links">
            <a href="crearSorteo.html">Crear Nuevo Sorteo</a>
            <a href="tableroControl.html">Tablero de Control</a>
            <a href="#" onclick="cerrarSesion()">Cerrar Sesion</a>
        </div>
    </nav>

    <h2>Crear Sorteo</h2>
    <div class="form-container">
        <form id="crearSorteoForm">
            <label for="nombre">Nombre del Sorteo</label>
            <input type="text" id="nombre" name="nombre" required>

            <label for="cantNumeros">Cantidad de Números</label>
            <input type="number" id="cantNumeros" name="cantNumeros" required>

            <label for="precio">Precio por Número</label>
            <input type="number" step="0.01" id="precio" name="precio" max="1000" required>

            <label for="fechaInicio">Fecha de Inicio</label>
            <input type="date" id="fechaInicio" name="fechaInicio" required>

            <label for="fechaFin">Fecha de Fin</label>
            <input type="date" id="fechaFin" name="fechaFin" required>

            <label for="fechaFinApartado">Fecha Límite de Apartado</label>
            <input type="date" id="fechaFinApartado" name="duracionApartado" required>

            <label for="imagen">Imagen (URL)</label>
            <input type="text" id="imagen" name="imagen">

            <button type="submit">Crear Sorteo</button>

            <a href="inicio.html" class="menu-button">Volver al Menú</a>
        </form>
    </div>
    <div id="messageContainer"></div>

    <script>
        function cerrarSesion() {
    Swal.fire({
        title: "¿Estás seguro?",
        text: "Se cerrará la sesión.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Sí, cerrar sesión",
        cancelButtonText: "Cancelar"
    }).then((result) => {
        if (result.isConfirmed) {
            localStorage.removeItem('idOrganizador');
            localStorage.removeItem('tipoUsuario');
            window.location.href = '/index.html';
        }
    });
 
}

        document.addEventListener('DOMContentLoaded', () => {
            const idOrganizador = localStorage.getItem('idOrganizador'); // Recupera el ID del organizador
            if (!idOrganizador) {
                alert('Error: No se pudo obtener el ID del organizador. Inicia sesión nuevamente.');
                window.location.href = '/login.html'; // Redirige al login si no hay ID
            }

            document.getElementById('crearSorteoForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = {
                    idOrganizador: parseInt(idOrganizador), // Usa el ID almacenado
                    nombre: document.getElementById('nombre').value,
                    cantNumeros: parseInt(document.getElementById('cantNumeros').value),
                    precio: parseFloat(document.getElementById('precio').value),
                    fechaInicio: document.getElementById('fechaInicio').value,
                    fechaFin: document.getElementById('fechaFin').value,
                    fechaFinApartado: document.getElementById('fechaFinApartado').value,
                    imagen: document.getElementById('imagen').value.trim(),
                    estado: 'activo',
                };

                try {
                    const response = await fetch('http://localhost:3000/api/v1/sorteos/crear', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData),
                    });

                    if (response.ok) {
                        const result = await response.json();
                        displayMessage(['Sorteo creado con éxito: ID ' + result.id], 'success');
                    } else {
                        try {
                            const error = await response.json();
                            console.log('Error response object:', error);

                            let errorMessages = [];

                            if (typeof error === 'object') {
                                if (typeof error.message === 'object') {
                                    // Procesa los mensajes de error por campo
                                    errorMessages = Object.entries(error.message).map(
                                        ([field, message]) => `${field}: ${message}`
                                    );
                                } else if (typeof error.message === 'string') {
                                    errorMessages.push(error.message);
                                } else {
                                    // Procesa cualquier otro formato de error
                                    errorMessages = Object.entries(error).map(
                                        ([field, message]) => `${field}: ${message}`
                                    );
                                }
                            } else {
                                errorMessages.push(error.message || error.error || 'Error desconocido');
                            }

                            displayMessage(['Error al crear el sorteo:', ...errorMessages], 'error');
                        } catch (jsonError) {
                            displayMessage(['Error al crear el sorteo:', 'Error desconocido (fallo al analizar la respuesta)'], 'error');
                        }
                    }
                } catch (err) {
                    console.error('Error en la solicitud:', err);
                    displayMessage(['Error de conexión, intenta nuevamente.'], 'error');
                }
            });
        });

        function displayMessage(messages, type) {
            const messageContainer = document.getElementById('messageContainer');

            if (Array.isArray(messages)) {
                const formattedMessages = messages.map(msg => `<li>${msg}</li>`).join('');
                messageContainer.innerHTML = `
                    <div class="alert ${type}">
                        <ul>${formattedMessages}</ul>
                    </div>
                `;
            } else {
                messageContainer.innerHTML = `<div class="alert ${type}">${messages}</div>`;
            }
        }
    </script>

</body>

</html>